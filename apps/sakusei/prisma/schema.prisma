// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AUTHENTICATION & USERS
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(CREATOR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  mediaFiles    MediaFile[]
  editedClips   EditedClip[]
  posts         Post[]
  dictionary    TranscriptionDictionary[]

  @@map("users")
}

enum UserRole {
  CREATOR  // Jay
  EDITOR   // Ange
  ADMIN    // Admin
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

// ============================================================
// MEDIA LIBRARY (Module 1)
// ============================================================

model MediaFile {
  id          String          @id @default(cuid())
  userId      String

  // File metadata
  filename    String
  mimeType    String
  fileSize    BigInt          // bytes
  duration    Int?            // seconds (for audio/video)
  width       Int?            // pixels (for video/image)
  height      Int?            // pixels (for video/image)

  // Storage paths
  vpsPath     String?         // /tmp/uploads/xxx.mp4
  cdnUrl      String?         // https://media.shinkofa.com/cdn-media/xxx.mp4
  thumbnailUrl String?        // https://media.shinkofa.com/cdn-media/xxx_thumb.jpg

  // Organization
  folder      MediaFolder     @default(RAW_JAY)
  tags        String[]

  // Status tracking
  status      MediaStatus     @default(UPLOADED)
  ftpStatus   FTPStatus       @default(PENDING)
  progress    Int             @default(0)  // 0-100

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  editedClips       EditedClip[]    @relation("SourceMedia")
  editedClipCuts    EditedClip[]    @relation("CutMediaFile")
  posts             Post[]          @relation("PostMedia")

  @@index([userId])
  @@index([folder])
  @@index([status])
  @@map("media_files")
}

enum MediaFolder {
  RAW_JAY        // Fichiers bruts uploadés par Jay
  EDITED_ANGE    // Clips édités par Ange
  PUBLISHED      // Contenus publiés
  ARCHIVE        // Archives
}

enum MediaStatus {
  UPLOADED       // Uploadé sur VPS
  PROCESSING     // En cours de traitement (transcription, transcode, etc.)
  READY          // Prêt à utiliser
  ERROR          // Erreur
}

enum FTPStatus {
  PENDING        // En attente de transfert O2Switch
  TRANSFERRING   // Transfert en cours
  COMPLETED      // Transféré sur CDN
  FAILED         // Échec transfert
}

// ============================================================
// VIDEO EDITOR (Module 2)
// ============================================================

model EditedClip {
  id              String      @id @default(cuid())
  userId          String
  sourceMediaId   String
  cutMediaFileId  String?     // Reference to the cut video file (after trim)

  // Clip info
  name            String
  startTime       Float       // seconds (trim point)
  endTime         Float       // seconds (trim point)

  // Transcription (Groq Whisper v3 output)
  transcription   Json?       // { segments: [{ start, end, text }] }
  subtitleStyle   Json?       // { font, size, color, position }

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceMedia     MediaFile   @relation("SourceMedia", fields: [sourceMediaId], references: [id], onDelete: Cascade)
  cutMediaFile    MediaFile?  @relation("CutMediaFile", fields: [cutMediaFileId], references: [id], onDelete: SetNull)
  exports         Export[]

  @@index([userId])
  @@index([sourceMediaId])
  @@index([cutMediaFileId])
  @@map("edited_clips")
}

model Export {
  id          String        @id @default(cuid())
  clipId      String

  // Export format
  format      ExportFormat
  resolution  String        // "1080x1920", "1920x1080", etc.
  aspectRatio String        // "9:16", "16:9", "1:1"

  // Processing status
  status      ExportStatus  @default(PENDING)
  progress    Int           @default(0)  // 0-100

  // Storage
  vpsPath     String?
  cdnUrl      String?
  fileSize    BigInt?
  duration    Float?        // Video duration in seconds

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  clip        EditedClip    @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@index([clipId])
  @@index([status])
  @@map("exports")
}

enum ExportFormat {
  TIKTOK_9_16      // 1080x1920, 9:16, 60s max
  YOUTUBE_16_9     // 1920x1080, 16:9
  LINKEDIN_16_9    // 1920x1080, 16:9
  INSTAGRAM_1_1    // 1080x1080, 1:1
  INSTAGRAM_9_16   // 1080x1920, 9:16 (Reels/Stories)
}

enum ExportStatus {
  PENDING      // En attente
  PROCESSING   // Transcoding en cours
  COMPLETED    // Export terminé
  FAILED       // Échec
}

// ============================================================
// PUBLICATION (Module 3)
// ============================================================

model Post {
  id                String        @id @default(cuid())
  userId            String

  // Content
  title             String
  masterContent     String        // Texte principal

  // Platform-specific overrides
  tiktokContent     String?
  linkedinContent   String?
  youtubeContent    String?
  instagramContent  String?

  hashtags          String[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  publications      Publication[]
  mediaFiles        MediaFile[]   @relation("PostMedia")

  @@index([userId])
  @@map("posts")
}

model Publication {
  id              String            @id @default(cuid())
  postId          String
  platform        SocialPlatform

  // Scheduling
  status          PublicationStatus @default(DRAFT)
  scheduledAt     DateTime?
  publishedAt     DateTime?

  // Platform response
  platformPostId  String?           // ID du post sur la plateforme
  platformUrl     String?           // URL du post publié
  errorMessage    String?

  // Analytics (future)
  views           Int               @default(0)
  likes           Int               @default(0)
  comments        Int               @default(0)
  shares          Int               @default(0)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  post            Post              @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([platform])
  @@index([status])
  @@map("publications")
}

enum SocialPlatform {
  TIKTOK
  LINKEDIN
  YOUTUBE
  INSTAGRAM
}

enum PublicationStatus {
  DRAFT        // Brouillon
  SCHEDULED    // Programmé
  PUBLISHING   // Publication en cours
  PUBLISHED    // Publié avec succès
  FAILED       // Échec publication
}

// ============================================================
// TRANSCRIPTION DICTIONARY
// ============================================================

model TranscriptionDictionary {
  id          String   @id @default(cuid())
  userId      String?

  term        String   // Terme à remplacer (ex: "l'ermitte")
  replacement String   // Remplacement (ex: "l'Ermite")
  caseSensitive Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, term])
  @@index([userId])
  @@map("transcription_dictionary")
}

// ============================================================
// TEMPLATES (Migration localStorage)
// ============================================================

model Template {
  id              String        @id @default(cuid())
  userId          String?       // Null = template système
  name            String
  type            TemplateType

  // Template data (JSON flexible)
  config          Json          // { backgroundColor, textColor, font, etc. }

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([type])
  @@map("templates")
}

enum TemplateType {
  VIDEO         // Modèle vidéo
  THUMBNAIL     // Modèle thumbnail
  COMPLETE      // Modèle complet (vidéo + thumbnail)
}
