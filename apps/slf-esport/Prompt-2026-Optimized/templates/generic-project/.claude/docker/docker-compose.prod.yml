# Docker Compose - Override Production
# Projet : [Nom Projet]
#
# Ce fichier override docker-compose.yml pour l'environnement de production.
#
# Usage:
#   docker-compose -f .claude/docker/docker-compose.yml -f .claude/docker/docker-compose.prod.yml up -d

version: '3.8'

services:
  # ============================================
  # Application - Configuration Prod
  # ============================================
  app:
    build:
      target: production  # Stage Dockerfile pour prod
      args:
        - BUILD_DATE=${BUILD_DATE}
        - VERSION=${VERSION:-1.0.0}
    # PAS de ports exposés directement (via nginx uniquement)
    # PAS de volumes montés (code dans l'image)
    environment:
      - DEBUG=false
      - LOG_LEVEL=info
      - WORKERS=${WORKERS:-4}
    command: >
      sh -c "
        echo 'Starting in PRODUCTION mode...' &&
        npm run start:prod
      "
      # OU pour Python/FastAPI:
      # gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
      # OU pour Django:
      # gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ============================================
  # Database - Configuration Prod
  # ============================================
  db:
    # PAS de ports exposés (accès interne uniquement)
    environment:
      - POSTGRES_HOST_AUTH_METHOD=md5  # Require password
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Redis - Configuration Prod
  # ============================================
  redis:
    # PAS de ports exposés (accès interne uniquement)
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Nginx - Reverse Proxy + SSL
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: ${PROJECT_NAME:-app}_nginx
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP
      - "443:443"  # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ../../static:/usr/share/nginx/html/static:ro  # Fichiers statiques
      - ./certbot/conf:/etc/letsencrypt:ro  # Certificats SSL
      - ./certbot/www:/var/www/certbot:ro   # Challenge ACME
    networks:
      - app-network
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Certbot - SSL/TLS Certificates
  # ============================================
  certbot:
    image: certbot/certbot:latest
    container_name: ${PROJECT_NAME:-app}_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - app-network

  # ============================================
  # Backup automatisé (optionnel)
  # ============================================
  backup:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-app}_backup
    restart: "no"
    environment:
      - PGPASSWORD=${DB_PASSWORD}
    volumes:
      - ../../backups:/backups
    networks:
      - app-network
    depends_on:
      - db
    entrypoint: >
      /bin/sh -c "
        echo 'Running database backup...' &&
        pg_dump -h db -U ${DB_USER:-postgres} ${DB_NAME:-app_db} > /backups/backup-$$(date +%Y%m%d-%H%M%S).sql &&
        echo 'Backup completed. Cleaning old backups...' &&
        find /backups -name 'backup-*.sql' -mtime +7 -delete &&
        echo 'Done.'
      "

volumes:
  nginx-cache:
    driver: local
