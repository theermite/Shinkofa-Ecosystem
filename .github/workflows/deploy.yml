name: Deploy - Shinkofa Ecosystem

on:
  # AUTO-DEPLOY: Triggered when CI passes on main/master
  workflow_run:
    workflows: ["CI - Shinkofa Ecosystem"]
    types:
      - completed
    branches: [main, master]

  # Manual deployment (backup option)
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy (all, michi, api-shizen)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - michi
          - api-shizen

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_PATH: /home/${{ secrets.VPS_USER }}/shinkofa-ecosystem

jobs:
  # ============================================
  # Check CI status (for workflow_run trigger)
  # ============================================
  check-ci:
    name: ðŸ” Check CI Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI conclusion
        id: check
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… CI passed - proceeding with deployment"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ CI failed - skipping deployment"
          fi

  # ============================================
  # Deploy Michi (Next.js) to VPS
  # Build happens on VPS where env vars are configured
  # ============================================
  deploy-michi:
    name: ðŸš€ Deploy Michi
    runs-on: ubuntu-latest
    needs: [check-ci]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'all' || github.event.inputs.app == 'michi')) ||
      (github.event_name == 'workflow_run' && needs.check-ci.outputs.should_deploy == 'true')
    environment:
      name: production
      url: https://app.shinkofa.com
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Michi to VPS
        run: |
          echo "ðŸš€ Deploying Michi to VPS..."
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ${{ env.VPS_PATH }}

            echo "ðŸ“¥ Pulling latest code..."
            git pull origin master

            echo "ðŸ“¦ Installing dependencies..."
            source ~/.nvm/nvm.sh
            nvm use 20
            pnpm install --frozen-lockfile

            echo "ðŸ—ï¸ Building Michi..."
            cd apps/michi
            pnpm build

            echo "ðŸ”„ Restarting service..."
            pm2 restart michi || pm2 start npm --name "michi" -- start

            echo "âœ… Michi deployed!"
          ENDSSH

      - name: Health check
        run: |
          echo "ðŸ¥ Checking Michi health..."
          sleep 10
          curl -f https://app.shinkofa.com/api/health || echo "âš ï¸ Health check failed but deployment completed"

  # ============================================
  # Deploy API-Shizen (FastAPI) to VPS
  # ============================================
  deploy-api-shizen:
    name: ðŸš€ Deploy API-Shizen
    runs-on: ubuntu-latest
    needs: [check-ci]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'all' || github.event.inputs.app == 'api-shizen')) ||
      (github.event_name == 'workflow_run' && needs.check-ci.outputs.should_deploy == 'true')
    environment:
      name: production
      url: https://api.shinkofa.com
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy API-Shizen to VPS
        run: |
          echo "ðŸš€ Deploying API-Shizen to VPS..."
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ${{ env.VPS_PATH }}

            echo "ðŸ§¹ Cleaning Python cache (CRITICAL for code updates)..."
            find apps/api-shizen -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            find apps/api-shizen -type f -name "*.pyc" -delete 2>/dev/null || true

            echo "ðŸ“¥ Pulling latest code..."
            git pull origin master

            echo "ðŸ“¦ Installing Python dependencies..."
            cd apps/api-shizen
            source venv/bin/activate || (python3.12 -m venv venv && source venv/bin/activate)
            pip install -r requirements.txt --upgrade

            echo "ðŸ§¹ Final cache cleanup after install..."
            find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true

            echo "ðŸ—ƒï¸ Running migrations..."
            alembic upgrade head || echo "âš ï¸ Migrations skipped or failed"

            echo "ðŸ”„ Restarting service..."
            pm2 restart api-shizen || pm2 start "uvicorn app.main:app --host 0.0.0.0 --port 8000" --name "api-shizen"

            echo "âœ… API-Shizen deployed!"
          ENDSSH

      - name: Health check
        run: |
          echo "ðŸ¥ Checking API-Shizen health..."
          sleep 10
          curl -f https://api.shinkofa.com/health || echo "âš ï¸ Health check failed but deployment completed"

  # ============================================
  # Deployment Summary
  # ============================================
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [deploy-michi, deploy-api-shizen]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Michi | ${{ needs.deploy-michi.result == 'success' && 'âœ… Deployed' || needs.deploy-michi.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API-Shizen | ${{ needs.deploy-api-shizen.result == 'success' && 'âœ… Deployed' || needs.deploy-api-shizen.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
